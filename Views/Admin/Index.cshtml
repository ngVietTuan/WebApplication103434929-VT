@model List<UserViewModel>
@using WebApplication103434929_VT.ModelView

@{
    ViewData["Title"] = "User Management";
}

<div class="container mt-5">
    <h1>User Management</h1>
    <button id="addUser" class="btn btn-primary mb-3" data-toggle="modal" data-target="#userModal">Add new User</button>
    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>UserName</th>
                <th>Email</th>
                <th>UserType</th>
                <th>Major</th>
                <th>Edit</th>
                <th>Reset</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody id="userTableBody">
            @foreach (var user in Model)
            {
                <tr data-user-id="@user.Id">
                    <td>@user.UserName</td>
                    <td>@user.Email</td>
                    <td>@user.UserType</td>
                    <td>@user.Major</td>
                    <td><button class="btn btn-info btn-sm edit-btn" data-toggle="modal" data-target="#editUserModal" data-user-id="@user.Id"><i class="fas fa-edit"></i> Edit</button></td>
                    <td><button class="btn btn-warning btn-sm reset-btn"><i class="fas fa-sync"></i> Reset</button></td>
                    <td><button class="btn btn-danger btn-sm delete-btn" data-toggle="modal" data-target="#deleteModal" data-user-id="@user.Id"><i class="fas fa-trash"></i> Delete</button></td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Pagination -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            @for (int i = 1; i <= ViewBag.TotalPages; i++)
            {
                <li class="page-item @(ViewBag.CurrentPage == i ? "active" : "")">
                    <a class="page-link" href="@Url.Action("Index", new { pageNumber = i })">@i</a>
                </li>
            }
        </ul>
    </nav>
</div>

<!-- User Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Add User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="form-group">
                        <label for="username">User Name</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="usertype">User Type</label>
                        <select class="form-control" id="usertype" required>
                            <option value="">Select user type</option>
                            <option value="teacher">Teacher</option>
                            <option value="student">Student</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="major">Select Major</label>
                        <select class="form-control" id="major" required>
                            <option value="">Select a major</option>
                            @foreach (var major in ViewBag.Majors)
                            {
                                <option value="@major.Id">@major.Name</option>
                            }
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label for="editUsername">User Name</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="editPhoneNumber">Phone Number</label>
                        <input type="text" class="form-control" id="editPhoneNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="editAddress">Address</label>
                        <input type="text" class="form-control" id="editAddress" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this user?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#userForm').submit(function (e) {
                e.preventDefault();

                var userId = $('#userId').val();
                var userData = {
                    Id: userId,
                    UserName: $('#username').val(),
                    Email: $('#email').val(),
                    UserType: $('#usertype').val(),
                    MajorId: $('#major').val(),
                    Password: 'Enroll@123'
                };

                var url = userId ? '@Url.Action("EditUser", "Admin")' : '@Url.Action("CreateUser", "Admin")';

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify(userData),
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        if (response.success) {
                            alert('User saved successfully');
                            $('#userModal').modal('hide');
                            location.reload(); // Reload the page to see changes
                        } else {
                            alert('Failed to save user: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                        alert('An error occurred while saving the user: ' + xhr.responseText);
                    }
                });
            });

            $('#editUserForm').submit(function (e) {
                e.preventDefault();

                var userId = $('#editUserId').val();
                var userData = {
                    Id: userId,
                    UserName: $('#editUsername').val(),
                    Email: $('#editEmail').val(),
                    PhoneNumber: $('#editPhoneNumber').val(),
                    Address: $('#editAddress').val()
                };

                $.ajax({
                    url: '@Url.Action("EditUser", "Admin")',
                    type: 'POST',
                    data: JSON.stringify(userData),
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        if (response.success) {
                            alert('User details updated successfully');
                            $('#editUserModal').modal('hide');
                            location.reload(); // Reload the page to see changes
                        } else {
                            alert('Failed to update user details: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr.responseText);
                        alert('An error occurred while updating the user details: ' + xhr.responseText);
                    }
                });
            });

            $('.edit-btn').click(function () {
                var userId = $(this).data('user-id');
                $.get('@Url.Action("GetUserById", "Admin")', { id: userId }, function (user) {
                    $('#editUserId').val(user.id);
                    $('#editUsername').val(user.userName);
                    $('#editEmail').val(user.email);
                    $('#editPhoneNumber').val(user.phoneNumber);
                    $('#editAddress').val(user.address);
                    $('#editUserModalLabel').text('Edit User');
                });
            });

            $('.delete-btn').click(function () {
                var userId = $(this).data('user-id');
                $('#confirmDelete').data('user-id', userId);
            });

            $('#confirmDelete').click(function () {
                var userId = $(this).data('user-id');
                $.post('@Url.Action("DeleteUser", "Admin")', { id: userId }, function (response) {
                    if (response.success) {
                        alert('User deleted successfully');
                        $('#deleteModal').modal('hide');
                        location.reload(); // Reload the page to see changes
                    } else {
                        alert('Failed to delete user: ' + response.message);
                    }
                });
            });
        });
    </script>
}