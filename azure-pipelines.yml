trigger:
- main

pool:
  name: 'Default'

variables:
  buildConfiguration: 'Release'

stages:
  - stage: Build
    jobs:
      - job: Build
        pool:
          name: 'Default'
        steps:
        - task: UseDotNet@2
          inputs:
            packageType: 'sdk'
            version: '8.x'
            installationPath: $(Agent.ToolsDirectory)/dotnet

        - task: NuGetToolInstaller@1

        - task: NuGetCommand@2
          inputs:
            restoreSolution: '**/*.sln'

        - task: VSBuild@1
          inputs:
            solution: '**/*.sln'
            msbuildArgs: '-property:Configuration=$(buildConfiguration)'
            platform: 'Any CPU'
            configuration: '$(buildConfiguration)'

        - task: VSTest@2
          inputs:
            platform: 'Any CPU'
            configuration: '$(buildConfiguration)'

        - powershell: |
            Invoke-WebRequest -Uri "https://chromedriver.storage.googleapis.com/114.0.5735.90/chromedriver_win32.zip" -OutFile "$(Agent.ToolsDirectory)/chromedriver.zip"
            Expand-Archive -Path "$(Agent.ToolsDirectory)/chromedriver.zip" -DestinationPath "$(Agent.ToolsDirectory)" -Force
            Remove-Item -Path "$(Agent.ToolsDirectory)/chromedriver.zip" -Force
          displayName: 'Download and install ChromeDriver'

        - task: ArchiveFiles@2
          inputs:
            rootFolderOrFile: '$(Build.ArtifactStagingDirectory)'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
            replaceExistingArchive: true

        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)'
            ArtifactName: 'drop'

  - stage: Deploy
    dependsOn: Build
    jobs:
      - job: Deploy
        pool:
          name: 'Default'
        steps:
        - download: current
          artifact: drop

        - powershell: |
            $ec2InstanceId = "i-0e990794ea9023a54"
            $region = "ap-southeast-2"
            $keyPath = "C:\\Users\\thait\\Downloads\\SWE40060.ppk"
            $user = "ec2-user"
            $artifactPath = "$(Pipeline.Workspace)\\drop\\*.zip"
            $remotePath = "/var/www/your-app"

            # Ensure PuTTY's pscp and plink are installed and accessible
            $pscpPath = "C:\\Program Files\\PuTTY\\pscp.exe"
            $plinkPath = "C:\\Program Files\\PuTTY\\plink.exe"

            # Extract the artifact
            Expand-Archive -Path $artifactPath -DestinationPath "$(Pipeline.Workspace)\\drop"

            # Copy files to EC2 instance
            & $pscpPath -i $keyPath -r "$(Pipeline.Workspace)\\drop\\*" $user@$ec2InstanceId:$remotePath

            # Connect to EC2 instance and restart the application
            & $plinkPath -i $keyPath $user@$ec2InstanceId "sudo systemctl restart your-app-service"
          displayName: 'Deploy to AWS EC2'
